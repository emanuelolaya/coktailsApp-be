CREATE OR REPLACE PROCEDURE CREATE_COCKTAIL (
  COCKTAIL_NAME IN VARCHAR2,
  COCKTAIL_DESCRIPTION IN VARCHAR2,
  COCKTAIL_GLASS_ID IN NUMBER,
  COKCTAIL_IMG_URL IN VARCHAR2,
  COCKTAIL_TASTE IN VARCHAR2,
  COCKTAIL_COLOR IN VARCHAR2,
  COCKTAIL_ALCOHOL_PERCENTAGE IN VARCHAR2,
  COCKTAIL_AUTHOR_ID IN NUMBER,
  COCKTAIL_PREPARACION IN VARCHAR2,
  COCKTAIL_RESOURCES_JSON IN CLOB,
  SP_RESULT OUT NUMBER
) AS
  V_COCKTAIL_ID NUMBER;
BEGIN
  INSERT INTO COCKTAIL
  (
    NAME,IMG_URL,ALCOHOL_PERCENTAGE,ID_AUTHOR,DESCRIPCION,PREPARACION,ID_GLASS,TASTE,COLOR
  ) VALUES (
    COCKTAIL_NAME,
    COKCTAIL_IMG_URL,
    COCKTAIL_ALCOHOL_PERCENTAGE,
    COCKTAIL_AUTHOR_ID,
    COCKTAIL_DESCRIPTION,
    COCKTAIL_PREPARACION,
    COCKTAIL_GLASS_ID,
    COCKTAIL_TASTE,
    COCKTAIL_COLOR
  ) RETURNING ID INTO V_COCKTAIL_ID;

  FOR ITEM IN (
    SELECT JT.ID, JT.CANTIDAD, JT.UNIDAD_MEDIDA
      FROM
        JSON_TABLE(COCKTAIL_RESOURCES_JSON,
          '$[*]' COLUMNS (
            ID NUMBER PATH '$.id',
            CANTIDAD NUMBER PATH '$.cantidad',
            UNIDAD_MEDIDA NUMBER PATH '$.unidad_medida') 
        ) JT
  )
  LOOP
    INSERT INTO COCKTAIL__COCKTAIL_RESOURCE 
    (
      COCKTAIL_ID,RESOURCE_ID,AMOUNT,MEASUREMENT_UNIT_ID
    ) VALUES (
      V_COCKTAIL_ID,
      ITEM.ID,
      ITEM.CANTIDAD,
      ITEM.UNIDAD_MEDIDA
    );
  END LOOP;
  SP_RESULT := 1;
  COMMIT;
EXCEPTION
  WHEN OTHERS THEN
  SP_RESULT := 0;
    ROLLBACK;
    RAISE;
END CREATE_COCKTAIL;